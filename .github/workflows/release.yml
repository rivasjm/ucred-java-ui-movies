name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-jar:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Build JAR
      run: mvn package -DskipTests

    - name: Upload JAR
      uses: actions/upload-artifact@v4
      with:
        name: jar-file
        path: target/ucred-java-ui-movies-*.jar

  build-windows:
    needs: build-jar
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Download JAR
      uses: actions/download-artifact@v4
      with:
        name: jar-file
        path: target/

    - name: Create Windows installer with jpackage
      run: |
        jpackage --input target `
          --name "UCRED Movies" `
          --main-jar ucred-java-ui-movies-1.0.0.jar `
          --type exe `
          --app-version 1.0.0 `
          --vendor "UCRED" `
          --description "Movie browser using TMDb API" `
          --win-dir-chooser `
          --win-shortcut `
          --win-menu

    - name: Upload Windows installer
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: "*.exe"

  build-macos:
    needs: build-jar
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Download JAR
      uses: actions/download-artifact@v4
      with:
        name: jar-file
        path: target/

    - name: Create macOS DMG with jpackage
      run: |
        jpackage --input target \
          --name "UCRED Movies" \
          --main-jar ucred-java-ui-movies-1.0.0.jar \
          --type dmg \
          --app-version 1.0.0 \
          --vendor "UCRED" \
          --description "Movie browser using TMDb API"

    - name: Upload macOS installer
      uses: actions/upload-artifact@v4
      with:
        name: macos-installer
        path: "*.dmg"

  build-linux:
    needs: build-jar
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Download JAR
      uses: actions/download-artifact@v4
      with:
        name: jar-file
        path: target/

    - name: Install jpackage dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y fakeroot

    - name: Create Linux DEB with jpackage
      run: |
        jpackage --input target \
          --name ucred-movies \
          --main-jar ucred-java-ui-movies-1.0.0.jar \
          --type deb \
          --app-version 1.0.0 \
          --vendor "UCRED" \
          --description "Movie browser using TMDb API" \
          --linux-shortcut

    - name: Upload Linux installer
      uses: actions/upload-artifact@v4
      with:
        name: linux-installer
        path: "*.deb"

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          jar-file/*.jar
          windows-installer/*.exe
          macos-installer/*.dmg
          linux-installer/*.deb
        body: |
          # UCRED Movies Browser ${{ github.ref_name }}
          
          Navegador de películas usando la API de The Movie Database (TMDb).
          
          ## Instaladores nativos
          - **Windows**: Descarga el archivo `.exe` y ejecuta el instalador
          - **macOS**: Descarga el archivo `.dmg`, ábrelo y arrastra la aplicación a la carpeta Aplicaciones
          - **Linux**: Descarga el archivo `.deb` e instala con `sudo dpkg -i ucred-movies_*.deb`
          
          ## JAR ejecutable
          También puedes usar el archivo `.jar` directamente con:
          ```bash
          export TMDB_API_KEY=tu_api_key_aqui
          java -jar ucred-java-ui-movies-1.0.0.jar
          ```
          
          ## Requisitos
          - Java 17 o superior (solo para el JAR)
          - API key de TMDb (obtén una gratis en https://www.themoviedb.org/settings/api)
        draft: false
        prerelease: false
